<h2 class="text-lg font-semibold">Terminado</h2>
<p class="text-sm text-slate-600 mt-1">Historial de actividades completadas.</p>

<%
  // Group items by date
  const today = new Date().toISOString().slice(0, 10);
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString().slice(0, 10);

  function getDateLabel(item) {
    const d = (item.completedAt || item.updatedAt || '').slice(0, 10);
    if (d === today) return 'Hoy';
    if (d === yesterday) return 'Ayer';
    if (d >= weekAgo) return 'Esta semana';
    return 'Antes';
  }

  const groups = new Map();
  const groupOrder = ['Hoy', 'Ayer', 'Esta semana', 'Antes'];
  for (const it of items) {
    const label = getDateLabel(it);
    if (!groups.has(label)) groups.set(label, []);
    groups.get(label).push(it);
  }
%>

<div class="mt-4 space-y-4">
  <% if (!items.length) { %>
    <div class="bg-white border rounded-xl overflow-hidden">
      <div class="empty-state m-4">
        <div class="text-4xl mb-3">ðŸŽ¯</div>
        <div class="text-base font-semibold text-slate-700 mb-2">Sin actividades completadas</div>
        <div class="text-sm text-slate-600 mb-4">
          Tu historial de tareas completadas aparecerÃ¡ aquÃ­.<br/>
          Â¡Comienza a completar tareas para ver tu progreso!
        </div>
        <a href="/hacer" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all text-sm font-medium hover:shadow-md">
          <span>âœ…</span>
          <span>Ir a Hacer</span>
        </a>
      </div>
    </div>
  <% } %>

  <% for (const label of groupOrder) { %>
    <% if (!groups.has(label)) continue; %>
    <div>
      <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2 px-1"><%= label %></div>
      <div class="space-y-1.5">
        <% for (const it of groups.get(label)) { %>
          <div class="bg-white border rounded-xl px-3 py-2.5">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium break-words"><%= it.title || it.input %></div>
                <div class="text-[11px] text-slate-400 mt-0.5">
                  <%= (it.completedAt || it.updatedAt || '').slice(0, 10) %> Â· Origen: <%= it.list || '-' %>
                </div>
              </div>
            </div>

            <% if (it.completionComment) { %>
              <!-- Show existing comment always -->
              <form method="POST" action="/terminado/<%= it.id %>/comment" class="mt-2" data-autosave-comment="1">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <input type="text" name="completionComment" value="<%= it.completionComment %>" placeholder="Comentario opcional" class="w-full border rounded-lg px-2.5 py-1.5 text-sm" />
              </form>
            <% } else { %>
              <!-- Show add-note toggle, reveal input on click -->
              <div class="mt-1.5">
                <button type="button" class="text-[11px] text-slate-400 hover:text-slate-600:text-slate-300 transition-colors add-note-btn">+ Agregar nota</button>
                <form method="POST" action="/terminado/<%= it.id %>/comment" class="hidden mt-1 add-note-form" data-autosave-comment="1">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                  <input type="text" name="completionComment" value="" placeholder="Comentario opcional" class="w-full border rounded-lg px-2.5 py-1.5 text-sm" />
                </form>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>
</div>

<script nonce="<%= cspNonce %>">
  (function () {
    // Toggle add-note
    document.querySelectorAll('.add-note-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var form = btn.nextElementSibling;
        if (!form) return;
        btn.classList.add('hidden');
        form.classList.remove('hidden');
        var input = form.querySelector('input[name="completionComment"]');
        if (input) input.focus();
      });
    });

    // Auto-save comment on blur or Enter
    document.querySelectorAll('form[data-autosave-comment="1"]').forEach(function(form) {
      var input = form.querySelector('input[name="completionComment"]');
      if (!input) return;
      var initial = input.value;

      function submitIfChanged() {
        var current = input.value;
        if (current === initial) return;
        initial = current;
        form.submit();
      }

      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); submitIfChanged(); }
      });
      input.addEventListener('blur', submitIfChanged);
    });
  })();
</script>
