<h2 class="text-lg font-semibold">Terminado</h2>
<p class="text-sm text-slate-600 mt-1">Historial de actividades completadas con fecha de cierre y comentario opcional.</p>

<div class="mt-4 space-y-2">
  <% if (!items.length) { %>
    <div class="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl overflow-hidden">
      <div class="empty-state m-4">
        <div class="text-4xl mb-3">ğŸ¯</div>
        <div class="text-base font-semibold text-slate-700 dark:text-slate-200 mb-2">Sin actividades completadas</div>
        <div class="text-sm text-slate-600 dark:text-slate-400 mb-4">
          Tu historial de tareas completadas aparecerÃ¡ aquÃ­.<br/>
          Â¡Comienza a completar tareas para ver tu progreso!
        </div>
        <a href="/hacer" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-all text-sm font-medium hover:shadow-md">
          <span>âœ…</span>
          <span>Ir a Hacer</span>
        </a>
      </div>
    </div>
  <% } %>

  <% for (const it of items) { %>
    <div class="bg-white border rounded-xl p-3">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm font-medium"><%= it.title || it.input %></div>
          <div class="text-xs text-slate-500 mt-1">Finalizada: <%= (it.completedAt || it.updatedAt || '').slice(0, 10) %> Â· Origen: <%= it.list || '-' %></div>
        </div>
      </div>

      <form method="POST" action="/terminado/<%= it.id %>/comment" class="mt-2" data-autosave-comment="1">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <input type="text" name="completionComment" value="<%= it.completionComment || '' %>" placeholder="Comentario opcional" class="w-full border rounded-lg px-2.5 py-1.5 text-sm" />
      </form>
    </div>
  <% } %>
</div>

<script nonce="<%= cspNonce %>">
  (function () {
    document.querySelectorAll('form[data-autosave-comment="1"]').forEach((form) => {
      const input = form.querySelector('input[name="completionComment"]');
      if (!input) return;
      let initial = input.value;

      function submitIfChanged() {
        const current = input.value;
        if (current === initial) return;
        initial = current;
        form.submit();
      }

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitIfChanged();
        }
      });

      input.addEventListener('blur', submitIfChanged);
    });
  })();
</script>
