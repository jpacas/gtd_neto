<h2 class="text-lg font-semibold dark:text-slate-100">Collect</h2>
<p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Captura rÃ¡pido y decide destino.</p>

<div class="mt-4 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl p-4">
  <form method="POST" action="/collect/add" class="space-y-2" id="collectForm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
    <label for="collectInput" class="sr-only">Nueva actividad</label>
    <textarea id="collectInput" name="input" rows="2" class="w-full border dark:border-slate-700 dark:bg-slate-900 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="Escribe una actividad..." aria-describedby="collect-help"></textarea>
    <button type="button" id="collectAddBtn" class="inline-flex items-center rounded-lg bg-blue-600 text-white px-4 py-2 hover:bg-blue-700 transition-colors">Agregar</button>
    <p id="collect-help" class="text-xs text-slate-500 dark:text-slate-400">Enter agrega Â· Shift+Enter salto de lÃ­nea.</p>
  </form>
</div>

<div id="collectList" class="mt-4 divide-y dark:divide-slate-700 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800 overflow-hidden">
  <% if (!items.length) { %>
    <div id="collectEmpty" class="empty-state m-3">
      <div class="text-4xl mb-3">ğŸ“¥</div>
      <div class="text-base font-semibold text-slate-700 dark:text-slate-200 mb-2">Tu bandeja estÃ¡ vacÃ­a</div>
      <div class="text-sm text-slate-600 dark:text-slate-400 mb-4">
        Captura rÃ¡pidamente ideas, tareas o recordatorios.<br/>
        DespuÃ©s podrÃ¡s organizarlos y asignarles un destino.
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-500">
        ğŸ’¡ Tip: Usa <kbd class="px-1.5 py-0.5 rounded bg-slate-200 dark:bg-slate-700 font-mono text-[10px]">Enter</kbd> para agregar rÃ¡pidamente
      </div>
    </div>
  <% } else { %>
    <div id="collectEmpty" class="empty-state m-3 hidden">
      <div class="text-4xl mb-3">ğŸ“¥</div>
      <div class="text-base font-semibold text-slate-700 dark:text-slate-200 mb-2">Tu bandeja estÃ¡ vacÃ­a</div>
      <div class="text-sm text-slate-600 dark:text-slate-400 mb-4">
        Captura rÃ¡pidamente ideas, tareas o recordatorios.<br/>
        DespuÃ©s podrÃ¡s organizarlos y asignarles un destino.
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-500">
        ğŸ’¡ Tip: Usa <kbd class="px-1.5 py-0.5 rounded bg-slate-200 dark:bg-slate-700 font-mono text-[10px]">Enter</kbd> para agregar rÃ¡pidamente
      </div>
    </div>
  <% } %>

  <% for (const it of items) { %>
    <div class="px-3 py-2">
      <div class="flex items-center justify-between gap-2">
        <form method="POST" action="/collect/<%= it.id %>/update" class="hidden flex-1 items-center gap-2 collect-edit-form" data-id="<%= it.id %>">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <input name="input" value="<%= it.title || it.input %>" class="w-full border rounded-md px-2 py-1 text-sm" />
          <button class="text-xs px-2 py-1 rounded border bg-white hover:bg-slate-50">Guardar</button>
        </form>

        <div class="collect-text-row flex-1 min-w-0" data-id="<%= it.id %>">
          <span class="text-sm"><%= it.title || it.input %></span>
        </div>

        <div class="flex items-center gap-1 shrink-0">
          <button type="button" class="text-slate-500 hover:text-slate-700 edit-toggle" data-id="<%= it.id %>" title="Editar" aria-label="Editar actividad">âœï¸</button>
          <button type="button" class="text-slate-400 hover:text-red-500 delete-btn" data-id="<%= it.id %>" title="Borrar" aria-label="Borrar actividad">ğŸ—‘ï¸</button>
        </div>
      </div>

      <% if (it.tags && it.tags.length > 0) { %>
        <div class="mt-1 flex flex-wrap gap-1">
          <% it.tags.forEach(tag => { %>
            <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300"><%= tag %></span>
          <% }); %>
        </div>
      <% } %>

      <form method="POST" action="/collect/<%= it.id %>/send" class="mt-1.5 flex flex-wrap items-center gap-1 collect-send-form" data-auto-loading="off">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <input type="hidden" name="destination" value="" />
        <% const destIcons = { hacer: 'âœ…', agendar: 'ğŸ—“ï¸', delegar: 'ğŸ¤', desglosar: 'ğŸ§©', 'no-hacer': 'ğŸš«' }; %>
        <% for (const d of destinations) { %>
          <button type="button" data-destination="<%= d.key %>" class="text-[11px] px-2 py-1 rounded border dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700"><%= destIcons[d.key] || '' %> <%= d.label %></button>
        <% } %>
      </form>
    </div>
  <% } %>
</div>

<script nonce="<%= cspNonce %>">
  (function () {
    const form = document.getElementById('collectForm');
    const input = document.getElementById('collectInput');
    const addBtn = document.getElementById('collectAddBtn');
    if (!form || !input || !addBtn) return;

    let isSubmitting = false;
    const csrfToken = '<%= csrfToken %>';
    const destIcons = { hacer: 'âœ…', agendar: 'ğŸ—“ï¸', delegar: 'ğŸ¤', desglosar: 'ğŸ§©', 'no-hacer': 'ğŸš«' };
    const destinationButtons = `<% for (const d of destinations) { %><button type="button" data-destination="<%= d.key %>" class="text-[11px] px-2 py-1 rounded border bg-white hover:bg-slate-50">${destIcons['<%= d.key %>'] || ''} <%= d.label %></button><% } %>`;

    function makeTempId() {
      const bytes = crypto.getRandomValues(new Uint8Array(8));
      return 'tmp_' + Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function attachEditHandlers(root = document) {
      root.querySelectorAll('.edit-toggle').forEach((btn) => {
        if (btn.dataset.bound === '1') return;
        btn.dataset.bound = '1';
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const edit = document.querySelector(`.collect-edit-form[data-id="${id}"]`);
          const row = document.querySelector(`.collect-text-row[data-id="${id}"]`);
          if (!edit || !row) return;
          edit.classList.remove('hidden');
          edit.classList.add('flex');
          row.classList.add('hidden');
          const field = edit.querySelector('input[name="input"]');
          if (field) field.focus();
        });
      });
    }

    function attachSendHandlers(root = document) {
      root.querySelectorAll('.collect-send-form').forEach((formEl) => {
        if (formEl.dataset.bound === '1') return;
        formEl.dataset.bound = '1';

        const hiddenDestination = formEl.querySelector('input[name="destination"]');
        const buttons = formEl.querySelectorAll('button[data-destination]');

        buttons.forEach((btn) => {
          btn.addEventListener('click', () => {
            if (!hiddenDestination) return;
            hiddenDestination.value = btn.dataset.destination || '';
            LoadingManager.show(btn);
            formEl.submit();
          });
        });
      });
    }

    function attachDeleteHandlers(root = document) {
      root.querySelectorAll('.delete-btn').forEach((btn) => {
        if (btn.dataset.bound === '1') return;
        btn.dataset.bound = '1';
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          if (!id || id.startsWith('tmp_')) return; // pending items can't be deleted yet
          const list = document.getElementById('collectList');
          const empty = document.getElementById('collectEmpty');
          const row = btn.closest('.px-3.py-2');
          if (!row) return;

          // Optimistic: animate and remove
          const sibling = row.nextSibling;
          row.style.transition = 'opacity 0.2s, transform 0.2s';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-16px)';
          await new Promise(r => setTimeout(r, 220));
          row.remove();

          const visibleRows = list ? list.querySelectorAll('.collect-text-row:not(.hidden), .optimistic-pending') : [];
          if (!visibleRows.length && empty) empty.classList.remove('hidden');

          try {
            const body = new URLSearchParams({ _csrf: csrfToken });
            const r = await fetch(`/items/${encodeURIComponent(id)}/delete`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json',
              },
              body,
            });
            if (!r.ok) {
              let msg = 'server_error';
              try { const d = await r.json(); msg = d?.error || msg; } catch {}
              throw new Error(msg + ' (' + r.status + ')');
            }
          } catch (err) {
            // Rollback: re-insert the row
            row.style.opacity = '';
            row.style.transform = '';
            if (list) list.insertBefore(row, sibling);
            if (empty) empty.classList.add('hidden');
            toast.error('No se pudo borrar el item. ' + (err?.message || ''));
          }
        });
      });
    }

    function buildRow(item, pending = false) {
      const wrapper = document.createElement('div');
      wrapper.className = 'px-3 py-2' + (pending ? ' optimistic-pending opacity-60' : '');
      if (pending) wrapper.style.position = 'relative';
      const idAttr = String(item.id || '').replaceAll('"', '&quot;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
      const idUrl = encodeURIComponent(String(item.id || ''));
      wrapper.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <form method="POST" action="/collect/${idUrl}/update" class="hidden flex-1 items-center gap-2 collect-edit-form" data-id="${idAttr}">
            <input type="hidden" name="_csrf" value="${csrfToken}" />
            <input name="input" class="w-full border rounded-md px-2 py-1 text-sm" />
            <button class="text-xs px-2 py-1 rounded border bg-white hover:bg-slate-50">Guardar</button>
          </form>
          <div class="collect-text-row flex-1 min-w-0" data-id="${idAttr}"><span class="text-sm"></span></div>
          <div class="flex items-center gap-1 shrink-0">
            <button type="button" class="text-slate-500 hover:text-slate-700 edit-toggle" data-id="${idAttr}" title="Editar" aria-label="Editar actividad">âœï¸</button>
            <button type="button" class="text-slate-400 hover:text-red-500 delete-btn" data-id="${idAttr}" title="Borrar" aria-label="Borrar actividad">ğŸ—‘ï¸</button>
          </div>
        </div>
        <form method="POST" action="/collect/${idUrl}/send" class="mt-1.5 flex flex-wrap items-center gap-1 collect-send-form" data-auto-loading="off">
          <input type="hidden" name="_csrf" value="${csrfToken}" />
          <input type="hidden" name="destination" value="" />
          ${destinationButtons}
        </form>
      `;
      const val = item.title || item.input || '';
      wrapper.querySelector('.collect-text-row span').textContent = val;
      wrapper.querySelector('.collect-edit-form input[name="input"]').value = val;

      if (pending) {
        const spinnerEl = document.createElement('span');
        spinnerEl.className = 'opt-spinner absolute right-2 top-2 text-slate-400 text-xs pointer-events-none';
        spinnerEl.setAttribute('aria-hidden', 'true');
        spinnerEl.textContent = 'â³';
        wrapper.appendChild(spinnerEl);
      }

      return wrapper;
    }

    function finalizeRow(row, realItem) {
      const realId = String(realItem.id || '');
      const realIdEnc = encodeURIComponent(realId);

      row.querySelectorAll('form[action]').forEach(f => {
        f.action = f.action.replace(/collect\/tmp_[a-f0-9]+\//, 'collect/' + realIdEnc + '/');
      });

      row.querySelectorAll('[data-id^="tmp_"]').forEach(el => {
        el.dataset.id = realId;
      });

      row.classList.remove('opacity-60', 'optimistic-pending');
      const spinner = row.querySelector('.opt-spinner');
      if (spinner) spinner.remove();
    }

    async function submitQuick() {
      const text = input.value.trim();
      if (!text || isSubmitting) return;

      isSubmitting = true;

      // Snapshot FormData and body BEFORE clearing input
      const formData = new FormData(form);
      const body = new URLSearchParams();
      for (const [k, v] of formData.entries()) body.append(k, v);
      const savedText = text;

      // Build and insert optimistic row immediately
      const tempId = makeTempId();
      const list = document.getElementById('collectList');
      const empty = document.getElementById('collectEmpty');
      const optimisticItem = { id: tempId, title: savedText };
      const row = buildRow(optimisticItem, true);
      row.classList.add('fade-in');
      if (list) list.insertBefore(row, list.children[1] || null);
      if (empty) empty.classList.add('hidden');
      attachEditHandlers(row);
      attachSendHandlers(row);
      attachDeleteHandlers(row);

      // Unblock the user immediately
      input.value = '';
      input.focus();
      isSubmitting = false;

      try {
        const r = await fetch('/collect/add', {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
        });

        let data = null;
        try {
          data = await r.json();
        } catch {
          throw new Error('bad_payload');
        }

        if (!r.ok || !data?.ok) {
          const msg = String(data?.message || data?.error || 'No se pudo guardar el item.');
          throw new Error(msg);
        }

        if (data.deduped) {
          // Remove optimistic row â€” item already exists
          row.style.transition = 'opacity 0.25s, transform 0.25s';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-16px)';
          setTimeout(() => row.remove(), 280);
          toast.info('Ese item ya estaba en Collect');
          return;
        }

        if (!data?.item) throw new Error('bad_payload');

        finalizeRow(row, data.item);
      } catch (err) {
        // Rollback: animate row out and restore input
        row.style.transition = 'opacity 0.25s, transform 0.25s';
        row.style.opacity = '0';
        row.style.transform = 'translateX(-16px)';
        setTimeout(() => {
          row.remove();
          const visibleRows = list ? list.querySelectorAll('.optimistic-pending, .collect-text-row:not(.hidden)') : [];
          if (!visibleRows.length && empty) empty.classList.remove('hidden');
        }, 280);

        input.value = savedText;
        input.focus();
        const msg = String(err?.message || 'No se pudo guardar el item.');
        toast.error(msg);
      }
    }

    addBtn.addEventListener('click', submitQuick);

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitQuick();
      }
    });

    attachEditHandlers();
    attachSendHandlers();
    attachDeleteHandlers();
    input.focus();
  })();
</script>
