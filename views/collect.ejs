<h2 class="text-lg font-semibold">Collect</h2>
<p class="text-sm text-slate-600 mt-1">Captura rápido. Si una actividad no está clara, se marca en rojo.</p>

<div class="mt-4 bg-white border rounded-xl p-4">
  <form method="POST" action="/collect/add" class="space-y-2" id="collectForm">
    <textarea id="collectInput" name="input" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="Escribe una actividad..."></textarea>
    <% if (needApiKey) { %>
      <input name="apiKey" type="password" class="w-full border rounded-lg px-3 py-2" placeholder="API key" />
    <% } %>
    <button type="button" id="collectAddBtn" class="inline-flex items-center rounded-lg bg-blue-600 text-white px-4 py-2 hover:bg-blue-700">Agregar</button>
    <p class="text-xs text-slate-500">Enter agrega · Shift+Enter salto de línea.</p>
  </form>
</div>

<div id="collectList" class="mt-4 divide-y rounded-xl border bg-white overflow-hidden">
  <% if (!items.length) { %>
    <div id="collectEmpty" class="p-4 text-sm text-slate-600">Collect está vacío.</div>
  <% } else { %>
    <div id="collectEmpty" class="p-4 text-sm text-slate-600 hidden">Collect está vacío.</div>
  <% } %>

  <% for (const it of items) { %>
    <div class="px-3 py-2 <%= it.actionableOk ? '' : 'bg-red-50' %>">
      <div class="flex items-center justify-between gap-2">
        <form method="POST" action="/collect/<%= it.id %>/update" class="hidden flex-1 items-center gap-2 collect-edit-form" data-id="<%= it.id %>">
          <% if (needApiKey) { %><input type="hidden" name="apiKey" value="<%= apiKey || '' %>" /><% } %>
          <input name="input" value="<%= it.title || it.input %>" class="w-full border rounded-md px-2 py-1 text-sm" />
          <button class="text-xs px-2 py-1 rounded border bg-white hover:bg-slate-50">Guardar</button>
        </form>

        <div class="collect-text-row flex-1 min-w-0" data-id="<%= it.id %>">
          <span class="text-sm"><%= it.title || it.input %></span>
        </div>

        <button type="button" class="text-slate-500 hover:text-slate-700 edit-toggle" data-id="<%= it.id %>" title="Editar">✏️</button>
      </div>

      <form method="POST" action="/collect/<%= it.id %>/send" class="mt-1.5 flex flex-wrap items-center gap-1">
        <% if (needApiKey) { %><input type="hidden" name="apiKey" value="<%= apiKey || '' %>" /><% } %>
        <% for (const d of destinations) { %>
          <button name="destination" value="<%= d.key %>" class="text-[11px] px-2 py-1 rounded border bg-white hover:bg-slate-50"><%= d.label %></button>
        <% } %>
      </form>

      <% if (!it.actionableOk) { %>
        <div class="text-[11px] text-red-700 mt-1"><%= it.actionableFeedback || 'Redacción poco accionable' %></div>
      <% } %>
    </div>
  <% } %>
</div>

<script>
  (function () {
    const form = document.getElementById('collectForm');
    const input = document.getElementById('collectInput');
    const addBtn = document.getElementById('collectAddBtn');
    if (!form || !input || !addBtn) return;

    let isSubmitting = false;
    const destinationButtons = `<% for (const d of destinations) { %><button name="destination" value="<%= d.key %>" class="text-[11px] px-2 py-1 rounded border bg-white hover:bg-slate-50"><%= d.label %></button><% } %>`;

    function attachEditHandlers(root = document) {
      root.querySelectorAll('.edit-toggle').forEach((btn) => {
        if (btn.dataset.bound === '1') return;
        btn.dataset.bound = '1';
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const edit = document.querySelector(`.collect-edit-form[data-id="${id}"]`);
          const row = document.querySelector(`.collect-text-row[data-id="${id}"]`);
          if (!edit || !row) return;
          edit.classList.remove('hidden');
          edit.classList.add('flex');
          row.classList.add('hidden');
          const field = edit.querySelector('input[name="input"]');
          if (field) field.focus();
        });
      });
    }

    function buildRow(item) {
      const actionableOk = !!item.actionableOk;
      const wrapper = document.createElement('div');
      wrapper.className = `px-3 py-2 ${actionableOk ? '' : 'bg-red-50'}`;
      wrapper.innerHTML = `
        <div class="flex items-center justify-between gap-2">
          <form method="POST" action="/collect/${item.id}/update" class="hidden flex-1 items-center gap-2 collect-edit-form" data-id="${item.id}">
            <% if (needApiKey) { %><input type="hidden" name="apiKey" value="<%= apiKey || '' %>" /><% } %>
            <input name="input" class="w-full border rounded-md px-2 py-1 text-sm" />
            <button class="text-xs px-2 py-1 rounded border bg-white hover:bg-slate-50">Guardar</button>
          </form>
          <div class="collect-text-row flex-1 min-w-0" data-id="${item.id}"><span class="text-sm"></span></div>
          <button type="button" class="text-slate-500 hover:text-slate-700 edit-toggle" data-id="${item.id}" title="Editar">✏️</button>
        </div>
        <form method="POST" action="/collect/${item.id}/send" class="mt-1.5 flex flex-wrap items-center gap-1">
          <% if (needApiKey) { %><input type="hidden" name="apiKey" value="<%= apiKey || '' %>" /><% } %>
          ${destinationButtons}
        </form>
        <div class="text-[11px] text-red-700 mt-1 ${actionableOk ? 'hidden' : ''}"></div>
      `;
      const val = item.title || item.input || '';
      wrapper.querySelector('.collect-text-row span').textContent = val;
      wrapper.querySelector('.collect-edit-form input[name="input"]').value = val;
      if (!actionableOk) {
        wrapper.querySelector('.text-red-700').textContent = item.actionableFeedback || 'Redacción poco accionable';
      }
      return wrapper;
    }

    function evaluateActionability(text) {
      const t = String(text || '').trim();
      const words = t.split(/\s+/).filter(Boolean);
      const first = (words[0] || '').toLowerCase();
      const vague = ['hacer', 'ver', 'revisar tema', 'pendiente', 'trabajar', 'organizar'];
      const startsWithInfinitive = /[aá]r$|er$|ir$/.test(first);
      const hasEnoughWords = words.length >= 2;
      const tooLong = t.length > 140;
      const hasVaguePattern = vague.some(v => t.toLowerCase() === v || t.toLowerCase().startsWith(v + ' '));

      let score = 0;
      if (startsWithInfinitive) score += 40;
      if (hasEnoughWords) score += 30;
      if (!tooLong) score += 20;
      if (!hasVaguePattern) score += 10;

      const feedback = [];
      if (!startsWithInfinitive) feedback.push('Empieza con un verbo en infinitivo.');
      if (!hasEnoughWords) feedback.push('Hazla más específica.');
      if (tooLong) feedback.push('Hazla más corta.');
      if (hasVaguePattern) feedback.push('Evita frases vagas.');
      return { actionableOk: score >= 70, actionableFeedback: feedback.join(' ') };
    }

    async function submitQuick() {
      const text = input.value.trim();
      if (!text || isSubmitting) return;
      isSubmitting = true;
      addBtn.disabled = true;

      const formData = new FormData(form);
      const body = new URLSearchParams();
      for (const [k, v] of formData.entries()) body.append(k, v);

      try {
        const r = await fetch('/collect/add', {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' },
          body,
        });
        if (!r.ok) throw new Error('request_failed');
        const data = await r.json();
        if (!data?.ok || !data?.item) throw new Error('bad_payload');

        const list = document.getElementById('collectList');
        const empty = document.getElementById('collectEmpty');
        const computed = evaluateActionability(data.item.title || data.item.input || '');
        const row = buildRow({ ...data.item, ...computed });
        if (list) list.insertBefore(row, list.children[1] || null);
        if (empty) empty.classList.add('hidden');
        attachEditHandlers(row);

        input.value = '';
        input.focus();
      } catch {
        form.submit();
      } finally {
        isSubmitting = false;
        addBtn.disabled = false;
      }
    }

    addBtn.addEventListener('click', submitQuick);

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitQuick();
      }
    });

    attachEditHandlers();
    input.focus();
  })();
</script>
